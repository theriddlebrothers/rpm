$(document).on("pageshow","#companyPage",function(){$.mobile.loading("show");var a=RPM.GetParam("id");RPM.SendApiRequest("get/company/"+a,null,"GET",function(a){$("h1").html(a.name);var b="";if(a.address)b+=a.address+"<br />";if(a.city)b+=a.city+", ";if(a.state)b+=a.state;if(a.zip)b+=" "+a.zip;$("#address").html(b);if(a.phone){$("#phone a").attr("href","tel:"+a.phone);$("#phone p").html(a.phone)}else{$("#phone").remove()}if(a.website){$("#website a").attr("href",a.website);$("#website p").html(a.website)}else{$("#website").remove()}$("#companyActions").listview("refresh");$.mobile.loading("hide")})});$(document).on("pageinit","#loginPage",function(){$("#loginForm").submit(function(a){a.preventDefault();var b=$("#username").val();var c=$("#password").val();RPM.SendApiRequest("authenticate",{username:b,password:c},"POST",function(a){if(a.success){RPM.SetUser({Id:a.id,Name:a.name,AuthToken:a.token,Email:a.email,Role:a.Role});$.mobile.changePage("projects.html",{transition:"pop"})}else{$(".message",$.mobile.activePage).html(a.message);$(".message",$.mobile.activePage).fadeIn()}})})});$(document).on("pageinit","#loginPage",function(){var a=RPM.GetUser();if(a!=null){RPM.SendApiRequest("doauth",null,"GET",function(a){if(a.success){$.mobile.changePage("projects.html",{transition:"pop"})}})}});$(document).on("pageinit","#projectPage",function(){});$(document).on("pageshow","#projectPage",function(){$.mobile.loading("show");var a=RPM.GetParam("id");RPM.SendApiRequest("get/project/"+a,null,"GET",function(b){$("h1").html(b.name);$("#company").html(b.company.name);$("#projectNumber").html(b.projectNumber);$("#retainedHours").html(b.retainer.hours);$("#timelogsLink").attr("href","timelogs.html?project="+b.id);$("#companyLink").attr("href","company.html?id="+b.company.id);$(".timelogEditLink").attr("href","timelog-edit.html?project="+a);$.mobile.loading("hide")})});$(document).on("pageinit","#projectsPage",function(){RPM.SendApiRequest("get/project",{"projects.status":"In Progress",sortdesc:"start_date"},"GET",function(a){var b="";for(var c in a){var d=a[c];b+='<li><a href="project.html?id='+d.id+'" data-transition="slide"><h3>'+d.name+"</h3><p>"+d.projectNumber+"</p></a></li>"}$("#projectList").html(b);$("#projectList").listview("refresh")})});$(document).on("pageinit","#settingsDialog",function(){$("#logout").live("tap",function(){RPM.SetUser(null);$.mobile.changePage("index.html",{transition:"pop",reload:true,reverse:true})})});$(document).on("pageinit","#timelogEditPage",function(){$("#timelogEditForm").submit(function(a){a.preventDefault();var b=RPM.GetUser();var c=$("#logDate").val();var d=$("#hours").val();var e=$("#description").val();var f=$("#task").val();var g=RPM.GetParam("timelog");RPM.SendApiRequest("timelog/edit",{log_date:RPM.FormatDate(c),description:e,hours:RPM.Pad(d,2)+":00",user:b.Id,task_id:f,id:g},"POST",function(a){if(!a.success){$(".message",$.mobile.activePage).html(a.message);$(".message",$.mobile.activePage).fadeIn();return false}history.back();return false})})});$(document).on("pageshow","#timelogEditPage",function(){var a=RPM.GetUser();var b=RPM.GetParam("project");var c=RPM.GetParam("timelog");if(c){RPM.SendApiRequest("get/timelog/"+c,null,"GET",function(b){$("#logDate").val(b.logDate);$("#description").val(b.description);$("#hours").val(b.hours);$("#task").val(b.task.id);$("#hours").slider("refresh");if(b.user.id!=a.Id){$("#saveTimelogButton").hide()}else{$("#saveTimelogButton").show()}})}RPM.SendApiRequest("get/task",{"project/project.id":b,sortasc:"name",status:"In Progress"},"GET",function(a){var b="";for(var c in a){var d=a[c];b+='<option value="'+d.id+'">'+d.name+"</option>"}$("#task").html(b);$("#task").selectmenu("refresh")});var d=new Date;var e=d.getDate();var f=d.getMonth()+1;var g=d.getFullYear();$("#logDate").val(RPM.Pad(f,2)+"/"+RPM.Pad(e,2)+"/"+g)});var timelogId=null;$(document).on("pageinit","#timelogsPage",function(){$(".options","#timelogList").live("tap",function(){timelogId=$(this).data("timelog")});$("#deleteTimelogLink").live("tap",function(){RPM.SendApiRequest("timelog/delete",{id:timelogId},"POST",function(a){if(a.success){var b=RPM.GetParam("project");$("#timelog-"+timelogId,"#timelogList").remove();$.mobile.changePage("timelogs.html?project="+b)}else{alert(a.message)}})})});$(document).on("pageshow","#timelogsPage",function(){$.mobile.loading("show");var a=RPM.GetParam("project");var b=RPM.GetUser();RPM.SendApiRequest("get/timelog",{"task/project.id":a,sortdesc:"log_date",limit:"50"},"GET",function(c){var d=null;var e="";for(var f in c){var g=c[f];var h=g.logDate;if(h!=d){e+='<li data-role="list-divider">'+g.logDate+"</li>"}d=h;e+='<li id="timelog-'+g.id+'"><a href="timelog-edit.html?project='+g.project.id+"&timelog="+g.id+'" data-transition="slideup">'+"<h3>"+g.description+"</h3>"+"<p>"+g.user.name+"</p>"+"</a>";if(g.user.id==b.Id){e+='<a class="options" href="#timelogOptions" data-timelog="'+g.id+'" data-position-to="window"  data-inline="true" data-rel="popup">Timelog Options</a>'}e+="</li>"}$("#timelogList").html(e);$("#timelogList").listview("refresh");$(".timelogEditLink").attr("href","timelog-edit.html?project="+a);$.mobile.loading("hide")})})